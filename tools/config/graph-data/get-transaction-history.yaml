name: get-transaction-history
description: |
  Retrieves comprehensive transaction history for suspicious activity investigation and SAR filing.

intent: |
  Gather complete transaction records for various investigation and compliance needs:
  - SAR Section 2.1: Chronological transaction evidence (what has been observed)
  - SAR Section 2.2: Nature of criminal property and quantum (total amounts)
  - SAR Section 2.3: Reason for suspicion (when/where/how - timeline, locations, patterns)
  - Fraud investigation: Transaction patterns, velocity analysis, anomaly detection
  - AML compliance: Transaction monitoring, threshold analysis, reporting

expected_patterns:
  - entity: Transaction
    shared_elements: [Account, Customer, Location, Device]
    anomaly: Structuring - multiple transactions just below reporting thresholds
  - entity: Transaction
    shared_elements: [Timestamp, Amount, Account]
    anomaly: Velocity anomalies - sudden increase in transaction frequency or unusual timing
  - entity: Transaction
    shared_elements: [Location, IP, Device]
    anomaly: Geographic anomalies - transactions from inconsistent locations
  - entity: Transaction
    shared_elements: [Account, Amount]
    anomaly: Round amount patterns - frequent transactions in round numbers indicating ML
  - entity: Transaction
    shared_elements: [Account, Timestamp]
    anomaly: Rapid movement (layering) - funds moving quickly through multiple accounts

reference_cypher: |
  MATCH (c:Customer {customerId: $customerId})-[:OWNS]->(a:Account)

  // Outgoing transactions
  OPTIONAL MATCH (a)-[t_out:TRANSACTION]->(targetAcc:Account)
  WHERE t_out.timestamp >= datetime($startDate)
    AND t_out.timestamp <= datetime($endDate)
    AND ($minAmount IS NULL OR t_out.amount >= $minAmount)
    AND ($maxAmount IS NULL OR t_out.amount <= $maxAmount)
  OPTIONAL MATCH (targetAcc)<-[:OWNS]-(targetCustomer:Customer)

  // Incoming transactions
  OPTIONAL MATCH (sourceAcc:Account)-[t_in:TRANSACTION]->(a)
  WHERE t_in.timestamp >= datetime($startDate)
    AND t_in.timestamp <= datetime($endDate)
    AND ($minAmount IS NULL OR t_in.amount >= $minAmount)
    AND ($maxAmount IS NULL OR t_in.amount <= $maxAmount)
  OPTIONAL MATCH (sourceAcc)<-[:OWNS]-(sourceCustomer:Customer)

  // Combine and return
  WITH collect(DISTINCT {
    transactionId: t_out.transactionId,
    timestamp: t_out.timestamp,
    amount: t_out.amount,
    currency: t_out.currency,
    type: t_out.type,
    direction: 'outgoing',
    fromAccount: a.accountNumber,
    toAccount: targetAcc.accountNumber,
    counterparty: targetCustomer.customerId,
    flags: t_out.flags,
    riskScore: t_out.riskScore
  }) + collect(DISTINCT {
    transactionId: t_in.transactionId,
    timestamp: t_in.timestamp,
    amount: t_in.amount,
    currency: t_in.currency,
    type: t_in.type,
    direction: 'incoming',
    fromAccount: sourceAcc.accountNumber,
    toAccount: a.accountNumber,
    counterparty: sourceCustomer.customerId,
    flags: t_in.flags,
    riskScore: t_in.riskScore
  }) AS transactions

  UNWIND transactions AS tx
  WHERE tx.transactionId IS NOT NULL
  RETURN collect(tx) AS transactions
  ORDER BY tx.timestamp DESC

reference_schema:
  labels: [Customer, Account, Transaction]
  relationships: [OWNS, TRANSACTION, PAYMENT, TRANSFER, WIRE]

parameters:
  - name: customerId
    type: string
    description: Customer ID to retrieve transactions for (or use accountNumber)
  - name: accountNumber
    type: string
    description: Account number to retrieve transactions for (or use customerId)
  - name: startDate
    type: string
    required: true
    description: Start of date range (ISO 8601 format)
  - name: endDate
    type: string
    required: true
    description: End of date range (ISO 8601 format)
  - name: minAmount
    type: number
    description: Minimum transaction amount filter
  - name: maxAmount
    type: number
    description: Maximum transaction amount filter
  - name: transactionTypes
    type: array
    description: Array of transaction types to include (wire, ach, check, card, cash, crypto)
